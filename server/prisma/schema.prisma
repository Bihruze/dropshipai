// DropshipAI Database Schema
// This is your Prisma schema file for defining the database structure.
// Learn more about Prisma: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Change to "sqlite" for local development
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id            String         @id @default(cuid())
  email         String         @unique
  name          String
  passwordHash  String?        // Hashed password for authentication
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  settings      Settings?
  products      Product[]
  orders        Order[]
  notifications Notification[]

  @@index([email])
}

// User settings and API configurations
model Settings {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Shopify Integration
  shopifyStoreUrl     String?
  shopifyAccessToken  String?  // Should be encrypted
  shopifyConnected    Boolean  @default(false)

  // Pricing Settings
  defaultMarkup       Float    @default(2.5)
  minProfitMargin     Float    @default(30)
  autoUpdatePrices    Boolean  @default(false)
  roundTo99           Boolean  @default(true)

  // API Keys (Should be encrypted)
  cjApiKey            String?
  claudeApiKey        String?
  telegramBotToken    String?
  telegramChatId      String?

  // Notification Settings
  notifyNewOrders     Boolean  @default(true)
  notifyLowStock      Boolean  @default(true)
  notifyDailySummary  Boolean  @default(false)

  // Preferences
  language            String   @default("English")
  currency            String   @default("USD")
  timezone            String   @default("UTC")

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// Product model
model Product {
  id               String        @id @default(cuid())
  userId           String
  user             User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  title            String
  description      String?
  price            Float
  costPrice        Float?
  compareAtPrice   Float?
  category         String?
  imageUrl         String?

  status           ProductStatus @default(draft)
  aiScore          Int?

  // Source information
  sourceType       String?
  sourceId         String?

  // Inventory
  sku              String?
  stock            Int           @default(0)
  lowStockThreshold Int          @default(5)

  // Shopify integration
  shopifyProductId String?

  // SEO
  bulletPoints     String[]
  seoTags          String[]
  metaDescription  String?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  orderItems       OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([sku])
  @@index([shopifyProductId])
}

enum ProductStatus {
  active
  draft
  paused
  archived
}

// Order model
model Order {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  shopifyOrderId  String?     @unique
  orderNumber     String

  customerName    String
  customerEmail   String

  address1        String
  address2        String?
  city            String
  state           String?
  zip             String
  country         String

  subtotal        Float
  shippingTotal   Float
  totalPrice      Float

  status          OrderStatus @default(pending)
  cjOrderId       String?
  trackingNumber  String?
  carrier         String?
  trackingUrl     String?

  orderDate       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  items           OrderItem[]

  @@index([userId])
  @@index([status])
  @@index([orderDate])
  @@index([customerEmail])
  @@index([trackingNumber])
}

enum OrderStatus {
  pending
  approved
  processing
  shipped
  delivered
  cancelled
}

// Order items
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  title       String
  quantity    Int
  price       Float
  cost        Float
  imageUrl    String?

  @@index([orderId])
  @@index([productId])
}

// Notifications
model Notification {
  id        String           @id @default(cuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  type      NotificationType
  title     String
  message   String
  isRead    Boolean          @default(false)
  data      Json?

  createdAt DateTime         @default(now())

  @@index([userId, isRead, createdAt])
  @@index([type])
}

enum NotificationType {
  order
  stock
  price
  system
}
